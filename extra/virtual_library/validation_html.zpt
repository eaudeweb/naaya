<metal:block define-macro="validate">

<fieldset id="duplicates-wrapper" style="display: none">
    <legend i18n:translate="">This entry might be a duplicate. Similar entries:</legend>
    <ul id="duplicates">
    </ul>
</fieldset>
<script>
(function() {
    var search_duplicates_in_progress = false;
    var search_duplicates_defered = false;
    function search_duplicates() {
        $('#duplicates-wrapper').hide();

        var title_en = $('#w_assessment-name-en').attr('value');
        var title_ru = $('#w_assessment-name-ru').attr('value');
        var year =  $('#w_assessment-year').attr('value');
        if (! (year && (title_en || title_ru)) ) {
            return;
        }

        if (search_duplicates_in_progress) {
            search_duplicates_defered = true;
            return;
        }

        search_duplicates_in_progress = true;
        $.ajax({
                url: 'virtual-library-viewer/get_close_answers',
                data:{'title_en:utf8:ustring': title_en,
                       'title_ru:utf8:ustring': title_ru,
                       'year:utf8:ustring': year},
                dataType: 'json',
                success: function(data) {
                    var dup_list = $('#duplicates');
                    dup_list.empty();

                    var current_answer_id = $('input[name="answer_id"]').val();
                    if (current_answer_id) {
                        var reg = new RegExp(current_answer_id + '$');
                    }

                    if (data && data.length > 0) {
                        for (var i = 0; i < data.length; i++) {
                            var item = data[i];
                            var url = item.answer_url;
                            var title = item.title;

                            if (reg && reg.test(item.answer_url)) // test current answer
                                continue

                            $('<li><a href="'+url+'">'+title+'<'+'/a><'+'/li>').appendTo(dup_list);
                        }
                        $('#duplicates-wrapper').show();
                    }
                },
                complete: function() {
                    search_duplicates_in_progress = false;
                    if (search_duplicates_defered) {
                        search_duplicates_defered = false;
                        search_duplicates();
                    }
                }
        });
    }

    $(document).ready(function() {
        $('#w_assessment-name-en').change(search_duplicates);
        $('#w_assessment-name-ru').change(search_duplicates);
        $('#w_assessment-year').change(search_duplicates);
    });
})();
</script>

<script tal:content="python:'var naaya_site_url=%s' % here.rstk.json_dumps(
                              here.getSite().absolute_url())"></script>
<script>$(function() {

	/*var widget_green_topics = $("label[for='w_green-economy-topics']").parent();
	var widget_green_efficiency = $("label[for='w_resource-efficiency-topics']").parent();
	var widget_water_topics = $("label[for='w_water-resources-topics']").parent();
	var widget_water_resources = $("label[for='w_water-resource-management-topics']").parent();


	$('<div '+'>').insertAfter(widget_green_efficiency).append(
		widget_green_topics,
		widget_green_efficiency,
		widget_water_topics,
		widget_water_resources
	).css({
		'background-color': '#ecf5fa',
		'border': '1px solid #b6cde1'
	}).children().css({
		'padding-left': '3em'
	});
	*/


	/*var widgets_by_theme = {
	  green: $('<div '+'>').insertAfter(widget_green_efficiency).append(
		widget_green_topics.prev('div.widgetEditMode'),
		widget_green_topics,
		widget_green_efficiency),
	  water:$('<div '+'>').insertAfter(widget_water_resources).append(
		widget_water_topics.prev('div.widgetEditMode'),
		widget_water_topics,
		widget_water_resources)
	};
	widgets_by_theme['green'].add(widgets_by_theme['water']).css({
		'background-color': '#ecf5fa',
		'border': '1px solid #b6cde1'
	}).children(':not(:first-child)').css({
		'padding-left': '3em'
	});

	function show_hide_widgets() {
		var theme_radio_id = $("input[name='w_theme:int']:checked").attr('id');
		if(theme_radio_id == 'w_theme_0') {
			widgets_by_theme['water'].hide();
			widgets_by_theme['green'].show();
		}
		else if(theme_radio_id == 'w_theme_1') {
			widgets_by_theme['water'].show();
			widgets_by_theme['green'].hide();
		}
		else if(theme_radio_id == 'w_theme_2') {
			widgets_by_theme['water'].show();
			widgets_by_theme['green'].show();
		}
		else {
			widgets_by_theme['water'].hide();
			widgets_by_theme['green'].hide();
		}
	}

	show_hide_widgets();
	$("input[name='w_theme:int']").click(show_hide_widgets);
	*/

	/*function map_pin_to_label(pin_id, label) {
		var url = naaya_site_url + '/portal_map/getSymbolPicture?id=' + pin_id;
		label.append(' ', $('<img'+'/>').attr('src', url));
	}

	map_pin_to_label('symbol825', $("label[for='w_theme_0']"));
	map_pin_to_label('symbol814', $("label[for='w_theme_1']"));
	map_pin_to_label('symbol851', $("label[for='w_theme_2']"));
	*/
});</script>

<tal:block define="schema_tool here/getSchemaTool"><script tal:content="string:
	var WWW_URL='${schema_tool/absolute_url}/www/';"></script></tal:block>

<script>
// http://gist.github.com/472607
$(function() {

	//JQuery UI dialogs
	//$( "#themes_details" ).dialog({
	//	width: 800,
	//	height: 500,
	//	modal: true,
	//	buttons: { "Close": function() { $(this).dialog("close"); } }
	//});

	//Unhide the main form (hidden so it only works with javascript turned on.
	$('form[name="frmAdd"]').show();

	$('#w_official-country-region_0').parent().hide();
	$('#w_geo-coverage-region').parent().hide();
	$('#w_type-document_0').parent().hide();
	$('#w_title-original-language').hide();

	languages_mapping = {'none':'Select language',
						'en':'English',
						'ro':'Romanian'}
	$('#w_title-original-language').before('<select id="languages_list">');
	$.each(languages_mapping, function(key, value){
		$('#languages_list')
			.append($('<option>', {value: key})
			.text(value));
		});

	$('#languages_list').after('<div id="new_language" style="display:none">');
	$('#new_language').append('<p id="new_language_explanation" class="tooltips">');
	$('#new_language').append('<input id="new_language_value" type="text">');
	$('#new_language_value').after(' <a id="add_language_value">');
	$('#add_language_value')
		.text('Add')
		.attr({
		'href': 'javascript:void(0);',
		});
	$('#new_language').after('<ul id="original_titles" class="no_bullets">');
	$('#languages_list').change(function(){
		if ($(this).val() != 'none'){
			if ($('#new_language_value:visible').length>0){
				$('#new_language_value').attr({
					'value': '',
					});
			}
			else {
				$('#new_language').slideDown();
			}
		}
	});
	$('#add_language_value').click(function(){
		update_language();
	})
	initialize_title_lines();

	function reset_languages_list(){
		$('#languages_list').val('none');
		$('#new_language_value').val('');
		$('#new_language').delay(500).slideUp();
	}

	function initialize_title_lines(){
		var original_titles = $('#w_title-original-language').val();
		if (original_titles.length>0)
		{
			var original_titles_list = original_titles.split('\n');
			$.each(original_titles_list, function(index, value){
				var splitted = value.split(' - ');
				lang = splitted[0];
				title = splitted[1];
				add_title_line(lang, title);
			})
		}
	}

	function update_language(remove){
		var current_value = $('#w_title-original-language').val();
		var lang_val = $('#languages_list').val();
		var lang = $('#languages_list option[value='+lang_val+']').text();
		if (remove){
			lang=remove;
		}
		var title = $('#new_language_value').val()
		if (title.length==0 && !remove){
			return;
		}
		if (current_value.length == 0){
			$('#w_title-original-language').val(lang+' - '+title);
			add_title_line(lang, title);
		}
		else{
			var current_values = current_value.split('\n');
			var found = false;

			for (i=0;i<current_values.length;i++){
				var curr_values = current_values[i].split(' - ');
				var curr_lan = curr_values[0];
				if (curr_lan == lang)
				{
					if (remove){
						$('#'+remove+'_original_title').fadeOut(300).delay(300, function(){$(this).remove();});
						current_values.splice(i, 1);
						found = true;
						reset_languages_list();
						break;
					}
					else{
						current_values[i]= lang+' - '+title;
						$('#'+lang+'_original_title').text();
						$('#'+lang+'_original_title .title').text(' '+lang+' - '+title);
						found = true;
					}
				}
			}
			if (! found)
			{
				current_values.push(lang+' - '+title);
				add_title_line(lang, title);
			}
			$('#w_title-original-language').val(current_values.join('\n'));
		}
		reset_languages_list();
	}

	function add_title_line(lang, title){
		var x_link = $('<a>').attr('href', 'javascript:void(0);');
		x_link.append($("<img>").attr({
			src: WWW_URL + "cross.gif",
			title:'Remove',
			alt: '[x]'
		})).addClass('tick-image icon-image');
		x_link.click(function(){
			update_language(lang);
		});
		var new_title_line = $('<li>').attr({
			'id': lang+'_original_title',
			'style': 'display:none',
			});
		
		new_title_line.append(x_link, '<span class="title"> '+lang+' - '+title+'<'+'/span>');
		new_title_line.appendTo($('#original_titles'));
		$('#'+lang+'_original_title').slideDown();
	}

	function checkboxes_to_dropdown(input_name) {
		var checkboxes = $("input[type=checkbox][name='"+input_name+"']");
		var the_ul = $('<ul'+'>').css('margin-top', '-1em');
		var the_select = $('<select'+'><option value=""'+'>-- select value --<'+'/option><'+'/select>');

		$([the_ul, the_select]).insertBefore(checkboxes.first());

		checkboxes.each(function() {
			var checkbox = $(this);
			var label = checkbox.next('label');

			var option = $('<option'+'>').text(label.text());
			option.attr('value', checkbox.attr('value'));
			the_select.append(option);

			if(checkbox.is(':checked')) {
				selected(option);
			}

			checkbox.next('label').next('br').remove();
			checkbox.next('label').remove();
			checkbox.remove();
		});

		the_select.change(function(evt) {
			var option = $('option:selected', the_select);
			if(option.val() == "") return;
			selected(option);
		});

		function selected(option) {
			var remove_button = $('<a href="javascript:;"'+'>[remove]<'+'/a>');
			remove_button.css({color: '#a00', 'font-size': '80%'});
			remove_button.click(function() {
				selected_li.remove();
				option.attr('disabled', null);
			});
			var hidden_input = $('<input type="hidden"'+'>').attr({
				name: input_name,
				value: option.attr('value')
			});
			var selected_li = $('<li'+'>').append(
				option.text(), ' ', remove_button, hidden_input);

			option.attr('disabled', 'disabled');
			$('option', the_select)[0].selected = true;
			the_ul.append(selected_li);
		}
	}


	checkboxes_to_dropdown('w_green-economy-topics:list');
	checkboxes_to_dropdown('w_resource-efficiency-topics:list');
	checkboxes_to_dropdown('w_water-resources-topics:list');
	checkboxes_to_dropdown('w_water-resource-management-topics:list');

	var widget_green_topics = $("label[for='w_green-economy-topics']").parent();
	var widget_green_efficiency = $("label[for='w_resource-efficiency-topics']").parent();
	var widget_water_topics = $("label[for='w_water-resources-topics']").parent();
	var widget_water_resources = $("label[for='w_water-resource-management-topics']").parent();

	function show_hide_widgets(){
		widget_green_topics.hide();
		widget_green_efficiency.hide();
		widget_water_topics.hide();
		widget_water_resources.hide();

		var themes_checked = $("input[name='w_theme:list']:checked");
		for (i=0;i<themes_checked.length;i++)
		{
			if (themes_checked[i].id == 'w_theme_0'){
				widget_green_topics.show();
			};
			if (themes_checked[i].id == 'w_theme_1'){
				widget_water_topics.show();
			};
			if (themes_checked[i].id == 'w_theme_2'){
				widget_water_resources.show();
			};
			if (themes_checked[i].id == 'w_theme_3'){
				widget_green_efficiency.show();
			};
		}
	}

	show_hide_widgets();
	$("input[name='w_theme:list']").click(function() {
		show_hide_widgets();
	});

});
</script>
</metal:block>
